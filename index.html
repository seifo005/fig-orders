<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ØªÙŠÙ† â€” v6.3.1</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; --warning:#f59e0b;
    --chip:#1f2937; --input:#0b1220; --border:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text);}
  header{ position:sticky; top:0; z-index:9999; background:linear-gradient(180deg,rgba(17,24,39,.98),rgba(17,24,39,.9)); backdrop-filter:blur(8px); padding:8px 12px; border-bottom:1px solid var(--border); }
  h1{font-size:18px; margin:0 0 6px 0}
  .sub{color:var(--muted); font-size:12px}
  .nav{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
  .tab{border:1px solid var(--border); background:#0b1220; color:#cbd5e1; padding:8px 12px; border-radius:999px; cursor:pointer; font-size:14px; user-select:none}
  .tab.active{background:var(--accent); color:#06250f; border-color:transparent; font-weight:700}
  .container{padding:12px; max-width:1200px; margin:0 auto}
  .grid{display:grid; gap:10px}
  .grid.two{grid-template-columns:2fr 1fr}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  input,select,textarea{width:100%; padding:10px 12px; background:var(--input); color:var(--text); border:1px solid var(--border); border-radius:10px; outline:none; font-size:14px}
  textarea{min-height:72px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .btns{display:flex; gap:8px; flex-wrap:wrap}
  button{ background:#1f2937; color:#e5e7eb; border:1px solid var(--border); padding:10px 12px; border-radius:10px; font-size:14px; cursor:pointer; }
  button.primary{background:var(--accent); color:#06250f; border-color:transparent; font-weight:700}
  button.secondary{background:var(--accent2); color:#081326; border-color:transparent; font-weight:700}
  button.warn{background:var(--warning); color:#261a05; border-color:transparent; font-weight:700}
  button.danger{background:var(--danger); color:#2b0a0a; border-color:transparent; font-weight:700}
  .table{width:100%; border-collapse:collapse; margin-top:8px}
  .table th,.table td{padding:8px; border-bottom:1px solid var(--border); font-size:13px; text-align:right; vertical-align:top}
  .chip{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip); color:#e5e7eb; font-size:12px}
  .status-New{background:#0b1220; color:#9ca3af}
  .status-Confirmed{background:#0b3a1a; color:#a7f3d0}
  .status-Ready{background:#3b2a05; color:#fde68a}
  .status-Delivered{background:#03281f; color:#6ee7b7}
  .status-Canceled{background:#2a0c0c; color:#fecaca}
  .muted{color:var(--muted)} .small{font-size:12px} .hidden{display:none}
  .statbar{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
  @media(min-width:680px){ .statbar{grid-template-columns:repeat(4,1fr)} }
  .stat{background:#0b1220; border:1px solid var(--border); padding:10px; border-radius:10px; font-size:13px}
  .badge{background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:11px; color:#cbd5e1}
  #err{position:fixed; left:8px; right:8px; bottom:8px; padding:10px; background:#7f1d1d; color:#fecaca; border:1px solid #ef4444; border-radius:10px; display:none; z-index:10000}

  /* Floating dock */
  .dock{
    position:fixed; right:12px; bottom:12px; z-index:10001;
    display:flex; gap:8px; background:rgba(17,24,39,.9); border:1px solid var(--border);
    padding:6px; border-radius:999px; backdrop-filter:blur(6px);
  }
  .dock button{
    border-radius:999px; padding:10px 14px; font-size:16px; border:1px solid var(--border);
    background:#0b1220; color:#cbd5e1;
  }
  .dock button.active{ background:var(--accent); color:#06250f; border-color:transparent; font-weight:700 }

  /* Big "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" button for quick escape */
  .home-fab{
    position:fixed; left:12px; bottom:12px; z-index:10001;
    background:var(--accent2); color:#081326; border:none; border-radius:999px; padding:10px 14px; font-weight:700;
    box-shadow:0 6px 20px rgba(0,0,0,.3);
  }
</style>
</head>
<body>
<header>
  <h1>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ØªÙŠÙ† â€” v6.3.1</h1>
  <div class="sub">Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª (Ø±Ø¦ÙŠØ³ÙŠØ©) â€¢ Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€¢ Ø§Ù„Ø£ØµÙ†Ø§Ù â€” ØªÙ†Ù‚Ù‘Ù„ Ø«Ø§Ø¨Øª + Ø³Ø¬Ù„ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¯Ø§Ø¦Ù…</div>
  <div class="nav">
    <button class="tab" data-view="stats" type="button">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª</button>
    <button class="tab" data-view="orders" type="button">ğŸ§¾ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    <button class="tab" data-view="catalog" type="button">ğŸ§º Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
  </div>
</header>

<div id="err"></div>

<div class="dock" id="dock">
  <button data-view="stats" type="button">ğŸ“Š</button>
  <button data-view="orders" type="button">ğŸ§¾</button>
  <button data-view="catalog" type="button">ğŸ§º</button>
</div>
<button class="home-fab" id="homeFab" type="button">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<section id="view-stats" class="container grid">
  <section class="card">
    <h2 style="margin:0 0 10px 0;">ğŸ“ˆ Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
    <div class="statbar">
      <div class="stat"><div class="muted small">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div><div id="s_orders" style="font-weight:700;font-size:18px">0</div></div>
      <div class="stat"><div class="muted small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´ØªÙ„Ø§Øª (Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</div><div id="s_qty" style="font-weight:700;font-size:18px">0</div></div>
      <div class="stat"><div class="muted small">Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</div><div id="s_sum" style="font-weight:700;font-size:18px">0</div></div>
      <div class="stat"><div class="muted small">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (Ù…Ø¤ÙƒØ¯/Ø¬Ø§Ù‡Ø²)</div><div id="s_pipe" style="font-weight:700;font-size:18px">0</div></div>
    </div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 10px 0;">ğŸ’° Ù…Ø¨ÙŠØ¹Ø§Øª Ù…ÙØ¤Ø±Ø´ÙØ© (ØªØ¨Ù‚Ù‰ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ±ÙŠØº)</h2>
    <div class="statbar">
      <div class="stat"><div class="muted small">Ø·Ù„Ø¨Ø§Øª Ù…ÙØ³Ù„Ù‘Ù…Ø© (Ø¥Ø¬Ù…Ø§Ù„ÙŠ)</div><div id="l_orders" style="font-weight:700;font-size:18px">0</div></div>
      <div class="stat"><div class="muted small">Ø´ØªÙ„Ø§Øª Ù…ÙØ³Ù„Ù‘Ù…Ø© (Ø¥Ø¬Ù…Ø§Ù„ÙŠ)</div><div id="l_qty" style="font-weight:700;font-size:18px">0</div></div>
      <div class="stat"><div class="muted small">Ø¥ÙŠØ±Ø§Ø¯ ØªØ±Ø§ÙƒÙ…ÙŠ</div><div id="l_sum" style="font-weight:700;font-size:18px">0</div></div>
      <div class="stat"><div class="muted small">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div><div id="l_last" style="font-weight:700;font-size:14px">â€”</div></div>
    </div>
    <div class="btns" style="margin-top:8px">
      <button id="ledgerArchive" class="secondary" type="button">Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØ³Ù„Ù‘Ù…Ø©)</button>
      <button id="ledgerExport" type="button">ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
      <button id="ledgerClear" class="danger" type="button">ØªÙØ±ÙŠØº Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
    </div>
    <table class="table" id="ledgerTbl">
      <thead><tr><th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø´ØªÙ„Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¯Ø¬)</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="small muted">ÙŠØ³Ø¬Ù„ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª **Ø§Ù„Ù…ÙØ³Ù„Ù‘Ù…Ø©** Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ â€œØ£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øªâ€. Ø§Ù„Ø³Ø¬Ù„ ÙŠØ¨Ù‚Ù‰ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ ØªÙØ±ÙŠØº Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</div>
  </section>
</section>

<section id="view-orders" class="container grid hidden">
  <section class="card">
    <h2 style="margin:0 0 10px 0;">ğŸ§¾ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    <div class="grid two">
      <section class="card">
        <h3 style="margin:0 0 8px 0;">â• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ / ØªØ¹Ø¯ÙŠÙ„</h3>
        <div class="grid">
          <div class="row">
            <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" /></div>
            <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="phone" placeholder="0555..." inputmode="tel"/></div>
          </div>

          <div class="row">
            <div><label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <select id="status">
                <option value="New">Ø¬Ø¯ÙŠØ¯</option>
                <option value="Confirmed">Ù…Ø¤ÙƒØ¯</option>
                <option value="Ready">Ø¬Ø§Ù‡Ø²</option>
                <option value="Delivered">Ù…ÙØ³Ù„Ù‘Ù…</option>
                <option value="Canceled">Ù…Ù„ØºÙ‰</option>
              </select>
            </div>
            <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="date" type="date"/></div>
          </div>

          <div class="row">
            <div><label>Ø§Ù„ØªÙˆØµÙŠÙ„</label>
              <select id="delivery">
                <option value="Office">Ù…ÙƒØªØ¨ ÙŠØ§Ù„ÙŠØ¯ÙŠÙ†</option>
                <option value="Home">Ù„Ù„Ø¹Ù†ÙˆØ§Ù†</option>
                <option value="Pickup">Ø§Ø³ØªÙ„Ø§Ù… ÙŠØ¯ÙˆÙŠ</option>
              </select>
            </div>
            <div><label>Ø§Ù„ÙˆÙ„Ø§ÙŠØ© / Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input id="city" placeholder="Ù…Ø«Ø§Ù„: Ø®Ù†Ø´Ù„Ø©"/></div>
          </div>

          <div><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="notes" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea></div>

          <div class="card" style="background:#0b1220; border-color:#1f2937">
            <h3 style="margin:0 0 8px 0;">ğŸ§º Ø£ØµÙ†Ø§Ù Ø§Ù„Ø·Ù„Ø¨</h3>
            <div class="row3">
              <div>
                <label>Ø§Ù„ØµÙ†Ù (Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)</label>
                <select id="i_variety_sel"></select>
                <div class="small muted">Ø­Ø±Ù‘Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ù† Ø¨ÙˆØ§Ø¨Ø© "Ø§Ù„Ø£ØµÙ†Ø§Ù".</div>
              </div>
              <div><label>Ø§Ù„Ø¹Ø¯Ø¯</label><input id="i_qty" type="number" min="1" value="1"/></div>
              <div><label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><input id="i_ppu" type="number" min="0" step="0.01" placeholder="Ø¯ÙŠÙ†Ø§Ø±"/></div>
            </div>
            <div class="btns" style="margin-top:8px">
              <button class="secondary" id="addItemBtn" type="button">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù</button>
            </div>
            <table class="table" id="itemsTbl">
              <thead><tr><th>#</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø³Ø¹Ø±/ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>â€”</th></tr></thead>
              <tbody></tbody>
            </table>
            <div class="small muted" id="itemsHint">Ø£Ø¶Ù ØµÙ†ÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨.</div>
          </div>

          <div class="btns">
            <button class="primary" id="saveBtn" type="button">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
            <button class="secondary" id="newBtn" type="button">ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
            <button class="warn hidden" id="dupBtn" type="button">ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ù„Ø¨</button>
            <button class="danger hidden" id="delBtn" type="button">Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨</button>
          </div>
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px 0;">ğŸ” Ø¨Ø­Ø« ÙˆØ£Ø¯ÙˆØ§Øª</h3>
        <div class="grid">
          <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„ØµÙ†Ù..." />
          <select id="filterStatus">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="New">Ø¬Ø¯ÙŠØ¯</option>
            <option value="Confirmed">Ù…Ø¤ÙƒØ¯</option>
            <option value="Ready">Ø¬Ø§Ù‡Ø²</option>
            <option value="Delivered">Ù…ÙØ³Ù„Ù‘Ù…</option>
            <option value="Canceled">Ù…Ù„ØºÙ‰</option>
          </select>
          <select id="filterVariety"><option value="">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ†Ù</option></select>
          <div class="btns">
            <button id="exportCSV" type="button">ØªØµØ¯ÙŠØ± CSV</button>
            <button id="exportJSON" type="button">ØªØµØ¯ÙŠØ± JSON</button>
            <label class="linklike">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON<input id="importJSON" type="file" accept=".json" class="hidden"/></label>
            <button id="printList" type="button">Ø·Ø¨Ø§Ø¹Ø©/ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø´Ø­Ù†</button>
            <button id="clearAll" class="danger" type="button">ØªÙØ±ÙŠØº Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù„Ø§ ÙŠÙ…Ø³Ù‘ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª)</button>
          </div>
        </div>
        <table class="table" id="ordersTbl">
          <thead>
            <tr>
              <th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø£ØµÙ†Ø§Ù</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªÙˆØµÙŠÙ„</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>â€”</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </section>
</section>

<section id="view-catalog" class="container grid hidden">
  <section class="card">
    <h2 style="margin:0 0 10px 0;">ğŸ§º Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>
    <div class="row">
      <div><label>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</label><input id="c_name" placeholder="Ù…Ø«Ø§Ù„: Black Madeira"/></div>
      <div><label>Ø³Ø¹Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ</label><input id="c_ppu" type="number" min="0" step="0.01" placeholder="Ø¯ÙŠÙ†Ø§Ø±"/></div>
    </div>
    <div class="btns" style="margin-top:8px">
      <button id="c_add" class="secondary" type="button">Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØµÙ†Ù</button>
      <button id="c_clear" class="danger" type="button">ØªÙØ±ÙŠØº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    </div>
    <table class="table" id="catTbl">
      <thead><tr><th>#</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø³Ø¹Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ</th><th>â€”</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="small muted">Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© â€œØ§Ù„Ø·Ù„Ø¨Ø§Øªâ€.</div>
  </section>
</section>

<script>
(function(){
  function showErr(msg){ try{ var e=document.getElementById('err'); if(!e) return; e.style.display='block'; e.textContent='âš ï¸ '+msg; }catch(_e){} }
  function $(s){ return document.querySelector(s); }
  function $$(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
  function fmt(n){ return (n||0).toLocaleString('ar-DZ'); }
  var STATUS_CLASSES={"New":"status-New","Confirmed":"status-Confirmed","Ready":"status-Ready","Delivered":"status-Delivered","Canceled":"status-Canceled"};
  function uid(){ return 'o_'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4); }
  function idItem(){ return 'it_'+Math.random().toString(36).slice(2,8); }
  function idCat(){ return 'cv_'+Math.random().toString(36).slice(2,8); }
  function escapeHTML(str){ return (str||'').toString().replace(/[&<>\"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m];}); }
  function statusLabel(s){ var m={'New':'Ø¬Ø¯ÙŠØ¯','Confirmed':'Ù…Ø¤ÙƒØ¯','Ready':'Ø¬Ø§Ù‡Ø²','Delivered':'Ù…ÙØ³Ù„Ù‘Ù…','Canceled':'Ù…Ù„ØºÙ‰'}; return m[s]||s; }
  function deliveryLabel(d){ var m={'Office':'Ù…ÙƒØªØ¨ ÙŠØ§Ù„ÙŠØ¯ÙŠÙ†','Home':'Ù„Ù„Ø¹Ù†ÙˆØ§Ù†','Pickup':'Ø§Ø³ØªÙ„Ø§Ù… ÙŠØ¯ÙˆÙŠ'}; return m[d]||d; }

  var K_ORD='fig_orders_v6'; var K_CAT='fig_varieties_v1'; var K_LED='fig_sales_ledger_v1';

  function loadCat(){ try{return JSON.parse(localStorage.getItem(K_CAT))||[];}catch(e){return [];} }
  function saveCat(x){ try{localStorage.setItem(K_CAT, JSON.stringify(x));}catch(e){showErr('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ†Ø§Ù');} }
  var catalog = loadCat();

  function renderCat(){
    try{
      var tbody=$('#catTbl tbody'); if(tbody) tbody.innerHTML='';
      for(var i=0;i<catalog.length;i++){
        var c=catalog[i], tr=document.createElement('tr');
        tr.innerHTML='<td class="small muted">'+(i+1)+'</td>'+
                     '<td>'+escapeHTML(c.name||'')+'</td>'+
                     '<td>'+fmt(c.ppu||0)+'</td>'+
                     '<td><a href="#" class="linklike" data-act="cedit" data-id="'+c.id+'">ØªØ¹Ø¯ÙŠÙ„</a> â€¢ <a href="#" class="linklike" data-act="cdel" data-id="'+c.id+'">Ø­Ø°Ù</a></td>';
        tbody.appendChild(tr);
      }
      var sel=$('#i_variety_sel'); if(sel){ sel.innerHTML=''; }
      var fsel=$('#filterVariety'); if(fsel){ fsel.innerHTML=''; var o0=document.createElement('option'); o0.value=''; o0.textContent='ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ†Ù'; fsel.appendChild(o0); }
      for(var j=0;j<catalog.length;j++){
        var op=document.createElement('option'); op.value=catalog[j].id; op.textContent=catalog[j].name; if(sel) sel.appendChild(op);
        var op2=document.createElement('option'); op2.value=catalog[j].name.toLowerCase(); op2.textContent=catalog[j].name; if(fsel) fsel.appendChild(op2);
      }
    }catch(e){ showErr(e.message); }
  }

  function loadOrders(){ try{return JSON.parse(localStorage.getItem(K_ORD))||[];}catch(e){return [];} }
  function saveOrders(x){ try{localStorage.setItem(K_ORD, JSON.stringify(x));}catch(e){showErr('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸');} }
  var orders = loadOrders();
  var editingId=null, currentItems=[];

  function getFormData(){
    var ex=null; for(var i=0;i<orders.length;i++){ if(orders[i].id===editingId){ ex=orders[i]; break; } }
    return {
      id: editingId||uid(),
      name:($('#name')&&$('#name').value||'').trim(),
      phone:($('#phone')&&$('#phone').value||'').trim(),
      status:($('#status')&&$('#status').value)||'New',
      delivery:($('#delivery')&&$('#delivery').value)||'Office',
      date:($('#date')&&$('#date').value)|| new Date().toISOString().slice(0,10),
      city:($('#city')&&$('#city').value||'').trim(),
      address:($('#address')&&$('#address').value||'').trim(),
      notes:($('#notes')&&$('#notes').value||'').trim(),
      items: currentItems.slice(),
      createdAt: ex && ex.createdAt ? ex.createdAt : Date.now(),
      updatedAt: Date.now()
    };
  }
  function setFormData(o){
    if($('#name')) $('#name').value=o&&o.name||'';
    if($('#phone')) $('#phone').value=o&&o.phone||'';
    if($('#status')) $('#status').value=o&&o.status||'New';
    if($('#delivery')) $('#delivery').value=o&&o.delivery||'Office';
    if($('#date')) $('#date').value=o&&o.date||'';
    if($('#city')) $('#city').value=o&&o.city||'';
    if($('#address')) $('#address').value=o&&o.address||'';
    if($('#notes')) $('#notes').value=o&&o.notes||'';
    currentItems=(o&&Array.isArray(o.items))? o.items.slice():[]; renderItems();
  }
  function clearForm(){ editingId=null; setFormData({items:[]}); if($('#dupBtn')) $('#dupBtn').classList.add('hidden'); if($('#delBtn')) $('#delBtn').classList.add('hidden'); }

  function findCatById(id){ for(var i=0;i<catalog.length;i++){ if(catalog[i].id===id) return catalog[i]; } return null; }
  function addItem(){
    var sel=$('#i_variety_sel'); var cid=sel? sel.value:''; var cv=findCatById(cid);
    if(!cv){ alert('Ø§Ø®ØªØ± ØµÙ†ÙÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'); return; }
    var q=parseInt(($('#i_qty')&&$('#i_qty').value)||'0',10)||0;
    var p=parseFloat(($('#i_ppu')&&$('#i_ppu').value)||'0')||0;
    if(q<=0){ alert('Ø§Ù„Ø¹Ø¯Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
    currentItems.push({id:idItem(), variety:cv.name, qty:q, ppu:p});
    if($('#i_qty')) $('#i_qty').value=1;
    if($('#i_ppu')) $('#i_ppu').value=cv.ppu||'';
    renderItems();
  }
  function renderItems(){
    var tbody=$('#itemsTbl tbody'); if(!tbody) return; tbody.innerHTML='';
    var total=0;
    for(var i=0;i<currentItems.length;i++){
      var it=currentItems[i], sum=(it.qty||0)*(it.ppu||0); total+=sum;
      var tr=document.createElement('tr');
      tr.innerHTML='<td class="small muted">'+(i+1)+'</td>'+
                   '<td>'+escapeHTML(it.variety||'')+'</td>'+
                   '<td>'+fmt(it.qty||0)+'</td>'+
                   '<td>'+fmt(it.ppu||0)+'</td>'+
                   '<td>'+fmt(Math.round(sum))+'</td>'+
                   '<td><a href="#" class="linklike" data-act="edit" data-id="'+it.id+'">ØªØ¹Ø¯ÙŠÙ„</a> â€¢ <a href="#" class="linklike" data-act="del" data-id="'+it.id+'">Ø­Ø°Ù</a></td>';
      tbody.appendChild(tr);
    }
    var hint=$('#itemsHint'); if(hint) hint.textContent=currentItems.length?('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ØµÙ†Ø§Ù Ø§Ù„Ø·Ù„Ø¨: '+currentItems.length+' | Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: '+fmt(Math.round(total))+' Ø¯Ø¬'):'Ø£Ø¶Ù ØµÙ†ÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù‚Ø¨Ù„ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨.';
  }

  function renderOrdersTable(){
    var q=($('#search')&&$('#search').value||'').trim().toLowerCase();
    var fs=($('#filterStatus')&&$('#filterStatus').value)||'';
    var fv=($('#filterVariety')&&$('#filterVariety').value||'').trim().toLowerCase();
    var tbody=$('#ordersTbl tbody'); if(tbody) tbody.innerHTML='';
    var filtered=orders.filter(function(o){
      var inSearch=!q || ((o.name&&o.name.toLowerCase().indexOf(q)>-1)||(o.phone&&o.phone.toLowerCase().indexOf(q)>-1)||((o.items||[]).some(function(it){return it&&it.variety&&it.variety.toLowerCase().indexOf(q)>-1;})));
      var inStatus=!fs || o.status===fs;
      var inVariety=!fv || ((o.items||[]).some(function(it){return it&&it.variety&&it.variety.toLowerCase().indexOf(fv)>-1;}));
      return inSearch && inStatus && inVariety;
    });
    filtered.sort(function(a,b){return (b.createdAt||0)-(a.createdAt||0)});
    for(var i=0;i<filtered.length;i++){
      var o=filtered[i], items=o.items||[], sum=0, qty=0;
      for(var k=0;k<items.length;k++){ sum+=((items[k].qty||0)*(items[k].ppu||0)); qty+=items[k].qty||0; }
      var names=items.map(function(it){return it&&it.variety}).filter(Boolean);
      var show=names.length<=2? escapeHTML(names.join('ØŒ ')) : escapeHTML(names[0])+'ØŒ '+escapeHTML(names[1])+' <span class="badge">+'+(names.length-2)+'</span>';
      var tr=document.createElement('tr');
      tr.innerHTML='<td class="small muted">'+(i+1)+'</td>'+
                   '<td>'+escapeHTML(o.name||'')+'</td>'+
                   '<td class="small">'+escapeHTML(o.phone||'')+'</td>'+
                   '<td>'+ (show||'-') +'</td>'+
                   '<td>'+fmt(qty)+'</td>'+
                   '<td><span class="chip '+(STATUS_CLASSES[o.status]||'')+'">'+statusLabel(o.status)+'</span></td>'+
                   '<td class="small">'+escapeHTML(deliveryLabel(o.delivery))+'</td>'+
                   '<td class="small">'+escapeHTML(o.city||'')+'</td>'+
                   '<td>'+fmt(Math.round(sum))+'</td>'+
                   '<td><a class="linklike" href="#" data-id="'+o.id+'">ÙØªØ­</a></td>';
      tbody.appendChild(tr);
    }
  }

  function loadLedger(){ try{return JSON.parse(localStorage.getItem(K_LED))||[];}catch(e){return [];} }
  function saveLedger(x){ try{localStorage.setItem(K_LED, JSON.stringify(x));}catch(e){showErr('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');} }
  var ledger = loadLedger();

  function archiveDelivered(){
    var added=0;
    for(var i=0;i<orders.length;i++){
      var o=orders[i]; if(o.status!=='Delivered') continue;
      var exists=false; for(var j=0;j<ledger.length;j++){ if(ledger[j].orderId===o.id){ exists=true; break; } }
      if(exists) continue;
      var items=o.items||[], sum=0, qty=0;
      for(var k=0;k<items.length;k++){ sum+=((items[k].qty||0)*(items[k].ppu||0)); qty+=items[k].qty||0; }
      ledger.push({ id:'lg_'+Math.random().toString(36).slice(2,10), orderId:o.id, name:o.name||'', phone:o.phone||'', city:o.city||'',
        date:o.date||new Date().toISOString().slice(0,10), totalQty:qty, totalSum:Math.round(sum), items:items, createdAt:Date.now() });
      added++;
    }
    if(added>0){ saveLedger(ledger); updateStats(); alert('ØªÙ…Øª Ø£Ø±Ø´ÙØ© '+added+' Ø·Ù„Ø¨/Ø·Ù„Ø¨Ø§Øª Ù…ÙØ³Ù„Ù‘Ù…Ø©.'); }
    else{ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙØ³Ù„Ù‘Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø£Ø±Ø´ÙØ©.'); }
  }

  function renderLedger(){
    var tbody=$('#ledgerTbl tbody'); if(tbody) tbody.innerHTML='';
    var totalOrders=ledger.length, totalQty=0, totalSum=0, last=0;
    for(var i=0;i<ledger.length;i++){
      var L=ledger[i]; totalQty+=L.totalQty||0; totalSum+=L.totalSum||0; if(L.createdAt && L.createdAt>last) last=L.createdAt;
      var tr=document.createElement('tr');
      tr.innerHTML='<td class="small muted">'+(i+1)+'</td>'+
                   '<td class="small">'+escapeHTML(L.date||'')+'</td>'+
                   '<td>'+escapeHTML(L.name||'')+'</td>'+
                   '<td class="small">'+escapeHTML(L.phone||'')+'</td>'+
                   '<td class="small">'+escapeHTML(L.city||'')+'</td>'+
                   '<td>'+fmt(L.totalQty||0)+'</td>'+
                   '<td>'+fmt(L.totalSum||0)+'</td>';
      tbody.appendChild(tr);
    }
    var l_orders=$('#l_orders'), l_qty=$('#l_qty'), l_sum=$('#l_sum'), l_last=$('#l_last');
    if(l_orders) l_orders.textContent=fmt(totalOrders);
    if(l_qty) l_qty.textContent=fmt(totalQty);
    if(l_sum) l_sum.textContent=fmt(Math.round(totalSum));
    if(l_last) l_last.textContent= last? new Date(last).toLocaleString('ar-DZ') : 'â€”';
  }

  function updateStats(){
    var filtered=orders.slice(); filtered.sort(function(a,b){return (b.createdAt||0)-(a.createdAt||0)});
    var totalQty=0,totalSum=0,pipe=0;
    for(var i=0;i<filtered.length;i++){
      var o=filtered[i], items=o.items||[];
      for(var k=0;k<items.length;k++){ totalQty+=(items[k].qty||0); totalSum+=((items[k].qty||0)*(items[k].ppu||0)); }
      if(o.status==='Confirmed' || o.status==='Ready'){ for(var k2=0;k2<items.length;k2++){ pipe+=(items[k2].qty||0); } }
    }
    var s_orders=$('#s_orders'), s_qty=$('#s_qty'), s_sum=$('#s_sum'), s_pipe=$('#s_pipe');
    if(s_orders) s_orders.textContent=fmt(filtered.length);
    if(s_qty) s_qty.textContent=fmt(totalQty);
    if(s_sum) s_sum.textContent=fmt(Math.round(totalSum));
    if(s_pipe) s_pipe.textContent=fmt(pipe);
    renderLedger();
  }

  function printOrders(){
    var q=($('#search')&&$('#search').value||'').trim().toLowerCase();
    var fs=($('#filterStatus')&&$('#filterStatus').value)||'';
    var fv=($('#filterVariety')&&$('#filterVariety').value||'').trim().toLowerCase();
    var filtered=orders.filter(function(o){
      var inSearch=!q || ((o.name&&o.name.toLowerCase().indexOf(q)>-1)||(o.phone&&o.phone.toLowerCase().indexOf(q)>-1)||((o.items||[]).some(function(it){return it&&it.variety&&it.variety.toLowerCase().indexOf(q)>-1;})));
      var inStatus=!fs || o.status===fs;
      var inVariety=!fv || ((o.items||[]).some(function(it){return it&&it.variety&&it.variety.toLowerCase().indexOf(fv)>-1;}));
      return inSearch Ùˆ inStatus Ùˆ inVariety;
    });
    var blocks=[], totalOrders=filtered.length;
    for(var i=0;i<filtered.length;i++){
      var o=filtered[i], items=o.items||[], sum=0, qtySum=0, lines=[];
      for(var k=0;k<items.length;k++){
        var it=items[k], ls=(it.qty||0)*(it.ppu||0); sum+=ls; qtySum+=it.qty||0;
        lines.push('   â€¢ '+(it.variety||'')+' Ã— '+(it.qty||0)+' â€” Ø³Ø¹Ø±/ÙˆØ­Ø¯Ø©: '+(it.ppu||0)+' â€” Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: '+Math.round(ls)+' Ø¯Ø¬');
      }
      var header=(i+1)+') '+(o.name||'')+' â€“ '+(o.phone||'')+' â€“ '+(o.city||'')+' â€“ '+statusLabel(o.status)+' â€“ '+deliveryLabel(o.delivery);
      var footer='   Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: '+Math.round(sum)+' Ø¯Ø¬   |   Ø¹Ø¯Ø¯ Ø§Ù„Ø´ØªÙ„Ø§Øª: '+qtySum;
      blocks.push(header+'\n'+lines.join('\n')+'\n'+footer);
    }
    var w=window.open('', '_blank'); if(!w){ alert('ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©. ÙØ¹Ù‘Ù„ Ø§Ù„Ù†Ø¨Ø«Ù‚Ø§Øª.'); return; }
    w.document.write('<!doctype html><html lang="ar" dir="rtl"><meta charset="utf-8"><title>Ù„Ø§Ø¦Ø­Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±</title>'+
      '<style>body{font-family:system-ui; padding:20px} h2{margin:0 0 12px 0} .muted{color:#555} pre{white-space:pre-wrap; font-size:14px; line-height:1.7}</style>'+
      '<h2>ğŸ§¾ Ù„Ø§Ø¦Ø­Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ± ('+ totalOrders +' Ø·Ù„Ø¨)</h2>'+
      '<div class="muted">Ø¹Ø±Ø¶ Ù…Ø¬Ù…Ù‘Ø¹ Ù„ÙƒÙ„ Ø²Ø¨ÙˆÙ† Ù…Ø¹ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ.</div>'+
      '<pre>'+ blocks.join('\n\n') +'</pre>'+
      '<script>window.print()</'+'script></html>');
    w.document.close();
  }

  function switchView(v){
    try{
      if(!v) v='stats';
      $$('.tab').forEach(function(t){ t.classList.toggle('active', t.getAttribute('data-view')===v); });
      $$('.dock button').forEach(function(b){ b.classList.toggle('active', b.getAttribute('data-view')===v); });
      var vs=$('#view-stats'), vo=$('#view-orders'), vc=$('#view-catalog');
      if(vs) vs.classList.toggle('hidden', v!=='stats');
      if(vo) vo.classList.toggle('hidden', v!=='orders');
      if(vc) vc.classList.toggle('hidden', v!=='catalog');
      if(location.hash!=='#'+v){ location.hash='#'+v; }
      window.scrollTo({top:0, behavior:'instant'});
    }catch(e){ showErr(e.message); }
  }
  function parseHash(){
    var h=(location.hash||'').replace('#','').trim();
    if(h!=='stats' && h!=='orders' && h!=='catalog') h='stats';
    return h;
  }

  function bind(){
    try{
      $$('.tab').forEach(function(t){ t.addEventListener('click', function(){ switchView(this.getAttribute('data-view')||'stats'); }); });
      $$('.dock button').forEach(function(b){ b.addEventListener('click', function(){ switchView(this.getAttribute('data-view')||'stats'); }); });
      $('#homeFab').addEventListener('click', function(){ switchView('stats'); });
      window.addEventListener('hashchange', function(){ switchView(parseHash()); });

      var cAdd=$('#c_add'); if(cAdd) cAdd.addEventListener('click', function(){
        var name=($('#c_name')&&$('#c_name').value||'').trim(); var ppu=parseFloat(($('#c_ppu')&&$('#c_ppu').value)||'0')||0;
        if(!name){ alert('Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ù…Ø·Ù„ÙˆØ¨'); return; }
        catalog.push({id:idCat(), name:name, ppu:ppu}); saveCat(catalog); renderCat();
        if($('#c_name')) $('#c_name').value=''; if($('#c_ppu')) $('#c_ppu').value='';
      });
      var cClear=$('#c_clear'); if(cClear) cClear.addEventListener('click', function(){ if(!confirm('ØªÙØ±ÙŠØº ÙƒÙ„ Ø§Ù„Ø£ØµÙ†Ø§ÙØŸ')) return; catalog=[]; saveCat(catalog); renderCat(); });
      var catTbl=$('#catTbl'); if(catTbl) catTbl.addEventListener('click', function(e){
        var a=e.target && e.target.closest ? e.target.closest('a[data-act]') : null; if(!a) return; e.preventDefault();
        var act=a.getAttribute('data-act'), id=a.getAttribute('data-id'), ix=-1; for(var i=0;i<catalog.length;i++){ if(catalog[i].id===id){ ix=i; break; } }
        if(ix<0) return;
        if(act==='cdel'){ if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')){ catalog.splice(ix,1); saveCat(catalog); renderCat(); } }
        else if(act==='cedit'){ var c=catalog[ix]; var n=prompt('Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù', c.name); if(n===null) return; var p=prompt('Ø³Ø¹Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ', c.ppu); if(p===null) return; p=parseFloat(p||'0')||0; if(!n){ alert('Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­'); return; } catalog[ix]={id:c.id, name:n.trim(), ppu:p}; saveCat(catalog); renderCat(); }
      });

      var varSel=$('#i_variety_sel'); if(varSel) varSel.addEventListener('change', function(){ var cv=findCatById(this.value); if($('#i_ppu') && cv){ $('#i_ppu').value=cv.ppu||0; } });
      var addItemBtn=$('#addItemBtn'); if(addItemBtn) addItemBtn.addEventListener('click', addItem);
      var itemsTbl=$('#itemsTbl'); if(itemsTbl) itemsTbl.addEventListener('click', function(e){
        var a=e.target && e.target.closest ? e.target.closest('a[data-act]') : null; if(!a) return; e.preventDefault();
        var act=a.getAttribute('data-act'), id=a.getAttribute('data-id'), ix=-1; for(var i=0;i<currentItems.length;i++){ if(currentItems[i].id===id){ ix=i; break; } }
        if(ix<0) return;
        if(act==='del'){ if(confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')){ currentItems.splice(ix,1); renderItems(); } }
        else if(act==='edit'){ var it=currentItems[ix]; var q=prompt('Ø§Ù„Ø¹Ø¯Ø¯', it.qty); if(q===null) return; var p=prompt('Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©', it.ppu); if(p===null) return; q=parseInt(q||'0',10)||0; p=parseFloat(p||'0')||0; if(q<=0){ alert('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©'); return; } currentItems[ix]={id:it.id, variety:it.variety, qty:q, ppu:p}; renderItems(); }
      });
      var saveBtn=$('#saveBtn'); if(saveBtn) saveBtn.addEventListener('click', function(){
        var o=getFormData(); if(!o.name){ alert('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨'); return; } if(!o.items||!o.items.length){ alert('Ø£Ø¶Ù ØµÙ†ÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
        for(var i=0;i<o.items.length;i++){ var it=o.items[i]; if(!it.variety||!it.qty||it.qty<=0){ alert('ØªØ­Ù‚Ù‚ Ù…Ù† Ø£ØµÙ†Ø§Ù Ø§Ù„Ø·Ù„Ø¨'); return; } }
        var idx=-1; for(var j=0;j<orders.length;j++){ if(orders[j].id===o.id){ idx=j; break; } }
        if(idx>=0){ orders[idx]=o; } else { orders.push(o); }
        saveOrders(orders); renderOrdersTable(); updateStats(); clearForm(); window.scrollTo(0,0);
      });
      var newBtn=$('#newBtn'); if(newBtn) newBtn.addEventListener('click', function(){ clearForm(); });
      var ordersTbl=$('#ordersTbl'); if(ordersTbl) ordersTbl.addEventListener('click', function(e){
        var a=e.target && e.target.closest ? e.target.closest('a[data-id]') : null; if(!a) return; e.preventDefault();
        var id=a.getAttribute('data-id'); var o=null; for(var i=0;i<orders.length;i++){ if(orders[i].id===id){ o=orders[i]; break; } } if(!o) return;
        editingId=id; setFormData(o); if($('#dupBtn')) $('#dupBtn').classList.remove('hidden'); if($('#delBtn')) $('#delBtn').classList.remove('hidden'); window.scrollTo(0,0);
      });
      var dupBtn=$('#dupBtn'); if(dupBtn) dupBtn.addEventListener('click', function(){
        if(!editingId) return; var o=null; for(var i=0;i<orders.length;i++){ if(orders[i].id===editingId){ o=orders[i]; break; } } if(!o) return;
        var copy=JSON.parse(JSON.stringify(o)); copy.id=uid(); copy.status='New'; copy.createdAt=Date.now(); copy.updatedAt=Date.now(); orders.push(copy); saveOrders(orders); renderOrdersTable(); updateStats(); alert('ØªÙ… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ ÙƒØ·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.');
      });
      var delBtn=$('#delBtn'); if(delBtn) delBtn.addEventListener('click', function(){
        if(!editingId) return; if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')) return;
        orders=orders.filter(function(x){ return x.id!==editingId; }); saveOrders(orders); renderOrdersTable(); updateStats(); clearForm();
      });
      var search=$('#search'); if(search) search.addEventListener('input', renderOrdersTable);
      var fs=$('#filterStatus'); if(fs) fs.addEventListener('input', renderOrdersTable);
      var fv=$('#filterVariety'); if(fv) fv.addEventListener('input', renderOrdersTable);
      var exportCSV=$('#exportCSV'); if(exportCSV) exportCSV.addEventListener('click', function(){
        var rows=[['order_id','name','phone','status','delivery','date','city','address','notes','item_variety','item_qty','item_ppu','item_sum','createdAt','updatedAt']];
        for(var i=0;i<orders.length;i++){ var o=orders[i]; var items=o.items||[]; for(var k=0;k<items.length;k++){ var it=items[k], sum=(it.qty||0)*(it.ppu||0);
          rows.push([o.id,o.name,o.phone,o.status,o.delivery,o.date,o.city,o.address,(o.notes||'').replace(/\n/g,' '),it.variety,it.qty, it.ppu, Math.round(sum), o.createdAt,o.updatedAt]); } }
        var csv=rows.map(function(r){return r.map(function(v){v=(v==null)?'':v; return '"'+v.toString().replace(/"/g,'""')+'"';}).join(',');}).join('\n');
        var blob=new Blob([csv],{type:'text/csv'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='orders_items.csv'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(url); a.remove();},200);
      });
      var exportJSON=$('#exportJSON'); if(exportJSON) exportJSON.addEventListener('click', function(){
        var blob=new Blob([JSON.stringify(orders,null,2)],{type:'application/json'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='orders.json'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(url); a.remove();},200);
      });
      var importJSON=$('#importJSON'); if(importJSON) importJSON.addEventListener('change', function(e){
        var f=e.target.files&&e.target.files[0]; if(!f) return; var reader=new FileReader();
        reader.onload=function(ev){ try{ var data=JSON.parse(ev.target.result); if(!Array.isArray(data)) throw new Error('JSON ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ØµÙÙˆÙØ©'); orders=data; saveOrders(orders); renderOrdersTable(); updateStats(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.'); }catch(err){ alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+err.message); } };
        reader.readAsText(f);
      });
      var printBtn=$('#printList'); if(printBtn) printBtn.addEventListener('click', printOrders);
      var clr=$('#clearAll'); if(clr) clr.addEventListener('click', function(){ if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·. Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù† ÙŠØªØ£Ø«Ø±. Ù…ØªØ£ÙƒØ¯ØŸ')) return; orders=[]; saveOrders(orders); renderOrdersTable(); updateStats(); clearForm(); });

      var lArc=$('#ledgerArchive'); if(lArc) lArc.addEventListener('click', archiveDelivered);
      var lExp=$('#ledgerExport'); if(lExp) lExp.addEventListener('click', function(){
        var blob=new Blob([JSON.stringify(ledger,null,2)],{type:'application/json'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='sales_ledger.json'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(url); a.remove();},200);
      });
      var lClr=$('#ledgerClear'); if(lClr) lClr.addEventListener('click', function(){ if(!confirm('ØªÙØ±ÙŠØº Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´Ù Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')) return; ledger=[]; saveLedger(ledger); renderLedger(); });

      if($('#date') && !$('#date').value) $('#date').value=new Date().toISOString().slice(0,10);
      var vs=$('#i_variety_sel'); if(vs && vs.value){ var cv=findCatById(vs.value); if(cv && $('#i_ppu')) $('#i_ppu').value=cv.ppu||0; }
    }catch(e){ showErr(e.message); }
  }

  function init(){
    try{
      renderCat();
      renderOrdersTable();
      updateStats();
      bind();
      var initial=(location.hash||'').replace('#',''); if(!initial) initial='stats';
      switchView(initial);
    }catch(e){ showErr(e.message); }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
})();
</script>
</body>
</html>