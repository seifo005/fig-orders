<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>FIG Orders — Fresh Start v1.0</title>
<style>
:root{
  --bg:#0f172a; --card:#111827; --text:#e5e7eb; --mut:#9ca3af;
  --border:#1f2937; --chip:#0b1220; --accent:#22c55e; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
header{position:fixed;top:0;left:0;right:0;z-index:1000;background:#111827;border-bottom:1px solid var(--border);padding:10px 12px}
h1{margin:0 0 6px 0;font-size:18px}
.sub{color:var(--mut);font-size:12px}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.tab{border:1px solid var(--border);background:#0b1220;color:#cbd5e1;padding:8px 12px;border-radius:999px;cursor:pointer}
.tab.active{background:var(--accent);color:#052a13;border-color:transparent;font-weight:700}
.container{max-width:1100px;margin:0 auto;padding:100px 12px 80px}
.view{display:none}
.view.active{display:block}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
input,select,textarea{width:100%;padding:10px;background:#0b1220;border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px}
button{border:1px solid var(--border);background:#0b1220;color:#e5e7eb;border-radius:10px;padding:10px 12px;cursor:pointer}
button.primary{background:var(--accent);color:#06250f;border-color:transparent;font-weight:700}
button.danger{background:var(--danger);color:#2b0a0a;border-color:transparent;font-weight:700}
.table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid var(--border);padding:8px;font-size:13px;text-align:right;vertical-align:top}
.badge{display:inline-block;background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:#cbd5e1;font-size:11px}
.dock{position:fixed;right:12px;bottom:calc(12px + env(safe-area-inset-bottom));z-index:1001;display:flex;gap:8px;background:rgba(17,24,39,.95);border:1px solid var(--border);padding:6px;border-radius:999px}
.dock button{border-radius:999px;padding:10px 14px}
.dock button.active{background:var(--accent);color:#052a13;border-color:transparent;font-weight:700}
.small{font-size:12px;color:var(--mut)}
</style>
</head>
<body>
<header>
  <h1>📋 FIG Orders — Fresh Start v1.0</h1>
  <div class="sub">بوابة الإحصاءات (رئيسية) • بوابة الطلبات • بوابة الأصناف</div>
  <div class="nav">
    <button class="tab" data-view="stats" type="button">📊 الإحصاءات</button>
    <button class="tab" data-view="orders" type="button">🧾 الطلبات</button>
    <button class="tab" data-view="catalog" type="button">🧺 الأصناف</button>
  </div>
</header>

<div class="dock">
  <button data-view="stats" type="button">📊</button>
  <button data-view="orders" type="button">🧾</button>
  <button data-view="catalog" type="button">🧺</button>
</div>

<!-- Stats -->
<section id="view-stats" class="container view active">
  <section class="card">
    <h2 style="margin:0 0 8px 0;">📈 ملخص</h2>
    <div class="row3">
      <div class="card"><div class="small">عدد الطلبات</div><div id="st_orders" style="font-weight:700;font-size:18px">0</div></div>
      <div class="card"><div class="small">إجمالي الشتلات</div><div id="st_qty" style="font-weight:700;font-size:18px">0</div></div>
      <div class="card"><div class="small">القيمة الإجمالية</div><div id="st_sum" style="font-weight:700;font-size:18px">0</div></div>
    </div>
  </section>
</section>

<!-- Orders -->
<section id="view-orders" class="container view">
  <section class="card">
    <h2 style="margin:0 0 8px 0;">🧾 الطلبات</h2>
    <div class="row2">
      <section class="card">
        <h3 style="margin:0 0 6px 0;">طلب جديد / تعديل</h3>
        <div class="row2">
          <div><label class="small">الاسم</label><input id="f_name" placeholder="اسم الزبون"></div>
          <div><label class="small">الهاتف</label><input id="f_phone" placeholder="05.."></div>
        </div>
        <div class="row2">
          <div><label class="small">الحالة</label>
            <select id="f_status">
              <option value="New">جديد</option>
              <option value="Confirmed">مؤكد</option>
              <option value="Ready">جاهز</option>
              <option value="Delivered">مُسلّم</option>
              <option value="Canceled">ملغى</option>
            </select>
          </div>
          <div><label class="small">التاريخ</label><input id="f_date" type="date"></div>
        </div>
        <div class="row2">
          <div><label class="small">التوصيل</label>
            <select id="f_delivery">
              <option value="Office">مكتب ياليدين</option>
              <option value="Home">للعنوان</option>
              <option value="Pickup">استلام يدوي</option>
            </select>
          </div>
          <div><label class="small">المدينة</label><input id="f_city" placeholder="خنشلة.."></div>
        </div>
        <div><label class="small">ملاحظات</label><textarea id="f_notes" placeholder="..."></textarea></div>

        <div class="card" style="background:#0b1220">
          <h4 style="margin:0 0 6px 0;">أصناف الطلب</h4>
          <div class="row3">
            <div>
              <label class="small">الصنف (من القائمة)</label>
              <select id="i_sel"></select>
              <div class="small">حرّر القائمة من بوابة "الأصناف"</div>
            </div>
            <div><label class="small">العدد</label><input id="i_qty" type="number" min="1" value="1"></div>
            <div><label class="small">سعر/وحدة</label><input id="i_ppu" type="number" min="0" step="0.01" placeholder="دج"></div>
          </div>
          <div style="margin-top:8px"><button id="i_add" type="button">إضافة الصنف</button></div>
          <table class="table" id="it_tbl">
            <thead><tr><th>#</th><th>الصنف</th><th>العدد</th><th>سعر/وحدة</th><th>المجموع</th><th>—</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="small" id="it_hint">أضف صنفًا واحدًا أو أكثر قبل الحفظ.</div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="primary" id="save" type="button">حفظ</button>
          <button id="new" type="button">تفريغ النموذج</button>
          <button class="danger" id="del" type="button" style="display:none">حذف</button>
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 6px 0;">قائمة الطلبات</h3>
        <input id="q" placeholder="بحث بالاسم / الهاتف / الصنف...">
        <table class="table" id="tbl">
          <thead><tr><th>#</th><th>الاسم</th><th>الهاتف</th><th>الأصناف</th><th>العدد</th><th>الإجمالي</th><th>—</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="print" type="button">طباعة لائحة التحضير</button>
          <button class="danger" id="clear" type="button">تفريغ الطلبات</button>
        </div>
      </section>
    </div>
  </section>
</section>

<!-- Catalog -->
<section id="view-catalog" class="container view">
  <section class="card">
    <h2 style="margin:0 0 8px 0;">🧺 الأصناف</h2>
    <div class="row2">
      <div><label class="small">اسم الصنف</label><input id="c_name" placeholder="Black Madeira"></div>
      <div><label class="small">سعر افتراضي</label><input id="c_ppu" type="number" min="0" step="0.01" placeholder="دج"></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="c_add" type="button">إضافة</button>
      <button class="danger" id="c_clear" type="button">تفريغ الأصناف</button>
    </div>
    <table class="table" id="c_tbl">
      <thead><tr><th>#</th><th>الصنف</th><th>سعر افتراضي</th><th>—</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</section>

<script>
(function(){
  // ===== Basic helpers =====
  function $(s){return document.querySelector(s)}
  function $$(s){return Array.prototype.slice.call(document.querySelectorAll(s))}
  function fmt(n){return (n||0).toLocaleString('ar-DZ')}
  function uid(){return 'o_'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4)}
  function idCat(){return 'cv_'+Math.random().toString(36).slice(2,8)}
  function idItem(){return 'it_'+Math.random().toString(36).slice(2,8)}

  // ===== Tabs routing (simple & robust)
  function switchView(v){
    var ids=['stats','orders','catalog']
    if(ids.indexOf(v)===-1) v='stats'
    $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.view===v))
    $$('.dock button').forEach(b=>b.classList.toggle('active', b.dataset.view===v))
    $('#view-stats').classList.toggle('active', v==='stats')
    $('#view-orders').classList.toggle('active', v==='orders')
    $('#view-catalog').classList.toggle('active', v==='catalog')
    if(location.hash!=='#'+v) location.hash='#'+v
    window.scrollTo(0,0)
  }
  $$('.tab').forEach(t=>t.addEventListener('click', ()=>switchView(t.dataset.view)))
  $$('.dock button').forEach(b=>b.addEventListener('click', ()=>switchView(b.dataset.view)))
  window.addEventListener('hashchange', ()=>switchView((location.hash||'').replace('#','')||'stats'))
  switchView((location.hash||'').replace('#','')||'stats')

  // ===== Storage keys =====
  const K_CAT='fig_catalog_v1', K_ORD='fig_orders_v1'

  function load(k){try{return JSON.parse(localStorage.getItem(k))||[]}catch(e){return[]}}
  function save(k,v){try{localStorage.setItem(k, JSON.stringify(v))}catch(e){alert('تعذر الحفظ')}}

  // ===== Catalog =====
  let catalog = load(K_CAT)
  function renderCatalog(){
    const tb=$('#c_tbl tbody'); tb.innerHTML=''
    catalog.forEach((c,i)=>{
      const tr=document.createElement('tr')
      tr.innerHTML = `<td class="small">${i+1}</td><td>${c.name||''}</td><td>${fmt(c.ppu||0)}</td>
      <td><a href="#" data-act="e" data-id="${c.id}">تعديل</a> • <a href="#" data-act="d" data-id="${c.id}">حذف</a></td>`
      tb.appendChild(tr)
    })
    // fill select in Orders
    const sel = $('#i_sel'); sel.innerHTML=''
    catalog.forEach(c=>{ const op=document.createElement('option'); op.value=c.id; op.textContent=c.name; sel.appendChild(op)})
  }
  $('#c_add').addEventListener('click', ()=>{
    const name=($('#c_name').value||'').trim(); const ppu=parseFloat($('#c_ppu').value||'0')||0
    if(!name){alert('اسم الصنف مطلوب');return}
    catalog.push({id:idCat(), name, ppu}); save(K_CAT,catalog); renderCatalog(); $('#c_name').value=''; $('#c_ppu').value=''
  })
  $('#c_clear').addEventListener('click', ()=>{ if(!confirm('تفريغ كل الأصناف؟'))return; catalog=[]; save(K_CAT,catalog); renderCatalog()})
  $('#c_tbl').addEventListener('click', (e)=>{
    const a=e.target.closest && e.target.closest('a[data-act]'); if(!a) return; e.preventDefault()
    const id=a.getAttribute('data-id'); const ix=catalog.findIndex(c=>c.id===id); if(ix<0) return
    if(a.dataset.act==='d'){ if(confirm('حذف الصنف؟')){ catalog.splice(ix,1); save(K_CAT,catalog); renderCatalog()} }
    else{ const n=prompt('اسم الصنف', catalog[ix].name); if(n===null) return; const p=parseFloat(prompt('سعر افتراضي', catalog[ix].ppu)||'0')||0; catalog[ix].name=n.trim(); catalog[ix].ppu=p; save(K_CAT,catalog); renderCatalog() }
  })

  // ===== Orders =====
  let orders = load(K_ORD)
  let editingId = null
  let items = []

  function setForm(o){
    $('#f_name').value=o.name||''; $('#f_phone').value=o.phone||''; $('#f_status').value=o.status||'New'
    $('#f_date').value=o.date||new Date().toISOString().slice(0,10); $('#f_delivery').value=o.delivery||'Office'
    $('#f_city').value=o.city||''; $('#f_notes').value=o.notes||''
    items = o.items? o.items.slice():[]; renderItems()
    $('#del').style.display = editingId? 'inline-block':'none'
  }
  function getForm(){
    const existing = editingId ? orders.find(x=>x.id===editingId) : null
    return {
      id: editingId || uid(),
      name: ($('#f_name').value||'').trim(),
      phone: ($('#f_phone').value||'').trim(),
      status: $('#f_status').value||'New',
      date: $('#f_date').value || new Date().toISOString().slice(0,10),
      delivery: $('#f_delivery').value||'Office',
      city: ($('#f_city').value||'').trim(),
      notes: ($('#f_notes').value||'').trim(),
      items: items.slice(),
      createdAt: existing && existing.createdAt ? existing.createdAt : Date.now(),
      updatedAt: Date.now()
    }
  }
  function renderItems(){
    const tb=$('#it_tbl tbody'); tb.innerHTML=''; let total=0
    items.forEach((it,i)=>{
      const sum=(it.qty||0)*(it.ppu||0); total+=sum
      const tr=document.createElement('tr')
      tr.innerHTML = `<td class="small">${i+1}</td><td>${it.variety}</td><td>${fmt(it.qty)}</td><td>${fmt(it.ppu)}</td><td>${fmt(Math.round(sum))}</td>
      <td><a href="#" data-act="e" data-i="${i}">تعديل</a> • <a href="#" data-act="d" data-i="${i}">حذف</a></td>`
      tb.appendChild(tr)
    })
    $('#it_hint').textContent = items.length? `إجمالي البنود: ${items.length} | المجموع التقريبي: ${fmt(Math.round(total))} دج` : 'أضف صنفًا واحدًا أو أكثر قبل الحفظ.'
  }
  $('#i_sel').addEventListener('change', ()=>{
    const cv=catalog.find(c=>c.id===$('#i_sel').value); if(cv) $('#i_ppu').value = cv.ppu || 0
  })
  $('#i_add').addEventListener('click', ()=>{
    const cv=catalog.find(c=>c.id===$('#i_sel').value); if(!cv){alert('اختر صنفًا');return}
    const q=parseInt($('#i_qty').value||'0',10)||0; const p=parseFloat($('#i_ppu').value||'0')||0
    if(q<=0){alert('عدد غير صالح');return}
    items.push({id:idItem(), variety:cv.name, qty:q, ppu:p}); $('#i_qty').value=1; $('#i_ppu').value=cv.ppu||''; renderItems()
  })
  $('#it_tbl').addEventListener('click', (e)=>{
    const a=e.target.closest && e.target.closest('a[data-act]'); if(!a) return; e.preventDefault()
    const i=parseInt(a.getAttribute('data-i')||'-1',10); if(i<0) return
    if(a.dataset.act==='d'){ if(confirm('حذف البند؟')){ items.splice(i,1); renderItems() } }
    else{ const q=parseInt(prompt('العدد', items[i].qty)||'0',10)||0; const p=parseFloat(prompt('سعر/وحدة', items[i].ppu)||'0')||0; if(q<=0){alert('قيمة غير صالحة');return} items[i].qty=q; items[i].ppu=p; renderItems() }
  })

  $('#save').addEventListener('click', ()=>{
    const o=getForm(); if(!o.name){alert('الاسم مطلوب');return} if(!o.items.length){alert('أضف صنفًا واحدًا');return}
    const ix = orders.findIndex(x=>x.id===o.id)
    if(ix>=0){ orders[ix]=o } else { orders.push(o) }
    save(K_ORD, orders); renderOrders(); setForm({items:[]}); editingId=null; updateStats(); alert(ix>=0? 'تم تحديث الطلب' : 'تم حفظ الطلب')
  })
  $('#new').addEventListener('click', ()=>{ editingId=null; setForm({items:[]}) })
  $('#del').addEventListener('click', ()=>{
    if(!editingId) return; if(!confirm('حذف الطلب نهائيًا؟'))return
    orders = orders.filter(x=>x.id!==editingId); save(K_ORD,orders); renderOrders(); editingId=null; setForm({items:[]}); updateStats()
  })

  function renderOrders(){
    const q=($('#q').value||'').trim().toLowerCase()
    const tb=$('#tbl tbody'); tb.innerHTML=''
    const filtered = orders.filter(o=> !q || (o.name&&o.name.toLowerCase().includes(q)) || (o.phone&&o.phone.toLowerCase().includes(q)) || (o.items||[]).some(it=>it.variety.toLowerCase().includes(q)) )
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))
    filtered.forEach((o,i)=>{
      const sum=(o.items||[]).reduce((s,it)=>s+(it.qty||0)*(it.ppu||0),0)
      const qty=(o.items||[]).reduce((s,it)=>s+(it.qty||0),0)
      const names=(o.items||[]).map(it=>it.variety).join('، ')
      const tr=document.createElement('tr')
      tr.innerHTML = `<td class="small">${i+1}</td><td>${o.name}</td><td class="small">${o.phone}</td><td>${names}</td><td>${fmt(qty)}</td><td>${fmt(Math.round(sum))}</td>
      <td><a href="#" data-id="${o.id}">فتح</a></td>`
      tb.appendChild(tr)
    })
  }
  $('#tbl').addEventListener('click', (e)=>{
    const a=e.target.closest && e.target.closest('a[data-id]'); if(!a) return; e.preventDefault()
    const id=a.getAttribute('data-id'); const o=orders.find(x=>x.id===id); if(!o) return
    editingId=id; setForm(o); switchView('orders'); window.scrollTo(0,0)
  })
  $('#q').addEventListener('input', renderOrders)

  $('#clear').addEventListener('click', ()=>{ if(!confirm('تفريغ كل الطلبات؟'))return; orders=[]; save(K_ORD,orders); renderOrders(); updateStats() })

  // Print list grouped per customer
  $('#print').addEventListener('click', ()=>{
    const blocks = orders.map((o,i)=>{
      const items = (o.items||[]).map(it=>{
        const s=(it.qty||0)*(it.ppu||0)
        return `   • ${it.variety} × ${it.qty} — سعر/وحدة: ${it.ppu} — المجموع: ${Math.round(s)} دج`
      }).join('\n')
      const total = (o.items||[]).reduce((s,it)=>s+(it.qty||0)*(it.ppu||0),0)
      const qty = (o.items||[]).reduce((s,it)=>s+(it.qty||0),0)
      return `${i+1}) ${o.name||''} – ${o.phone||''} – ${o.city||''}\n${items}\n   الإجمالي الكلي: ${Math.round(total)} دج   |   عدد الشتلات: ${qty}`
    })
    const w=window.open('','_blank')
    if(!w){alert('يمنع المتصفح فتح النافذة');return}
    w.document.write(`<!doctype html><html lang="ar" dir="rtl"><meta charset="utf-8"><title>لائحة التحضير</title>
    <style>body{font-family:system-ui;padding:20px} h2{margin:0 0 12px 0} pre{white-space:pre-wrap;line-height:1.7}</style>
    <h2>🧾 لائحة التحضير (${orders.length} طلب)</h2><pre>${blocks.join('\n\n')}</pre><script>window.print()</script>`)
    w.document.close()
  })

  // ===== Stats =====
  function updateStats(){
    const totalOrders = orders.length
    const totalQty = orders.reduce((s,o)=>s+(o.items||[]).reduce((a,it)=>a+(it.qty||0),0),0)
    const totalSum = orders.reduce((s,o)=>s+(o.items||[]).reduce((a,it)=>a+(it.qty||0)*(it.ppu||0),0),0)
    $('#st_orders').textContent = fmt(totalOrders)
    $('#st_qty').textContent    = fmt(totalQty)
    $('#st_sum').textContent    = fmt(Math.round(totalSum))
  }

  // ===== Init =====
  // Default date
  $('#f_date').value = new Date().toISOString().slice(0,10)
  renderCatalog(); renderOrders(); updateStats(); setForm({items:[]})
})();
</script>
</body>
</html>